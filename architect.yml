name: examples/cuttlefish
author: Architect.io

interfaces:
  web: ${ services.web.interfaces.main.url }

services:
  web:
    build:
      context: ./
      dockerfile: ./dockerfiles/web.Dockerfile
    description: Frontend application for cuttlefish
    language: ruby
    interfaces:
      main: 3000
    environment:
      PORT: ${ services.web.interfaces.main.port }
    debug:
      volumes:
        app:
          host_path: ./
          mount_path: /app
    # TODO: links: db, redis, smtp

  # guard:
  #   build:
  #     context: ./dockerfiles/web.Dockerfile
  #   description: TODO
  #   language: ruby
  #   # interfaces:
  #   #   main:
  #   command: bundle exec guard --no-interactions
    # volumes:
    #   app:
    #     host_path: ./
    #     mount_path: /app
  #   # TODO: links to db

  db:
    image: postgres:10.5
    interfaces:
      postgres: 5432

  smtp:
    build:
      context: ./
      dockerfile: ./dockerfiles/smtp.Dockerfile
    description: TODO
    language: ruby
    interfaces:
      main: 2525
    debug:
      volumes:
        app:
          host_path: ./
          mount_path: /app

  redis:
    image: redis:4.0
    interfaces:
      main: 6379

  # worker:
  #   build:
  #     context: ./dockerfiles/worker.Dockerfile
  #   description: TODO
  #   language: ruby
    # volumes:
    #   app:
    #     host_path: ./
    #     mount_path: /app
  #   # links: TODO db redis postfix

  postfix:
    image: juanluisbaptiste/postfix
    environment:
      SMTP_SERVER: ${ services.mailcatcher.interfaces.smtp.host } examples.cuttlefish.mailcatcher.latest # TODO: architect host
      SMTP_PORT: ${ services.mailcatcher.interfaces.smtp.port }  # TODO: architect port
      SMTP_USERNAME: foo@bar.com
      SMTP_PASSWORD: XXXXXXXX
      SERVER_HOSTNAME: cuttlefish.io
    interfaces:
    debug:
      volumes:
        postfix_logs:
          host_path: ./postfix_log
          mount_path: /var/log

  mailcatcher:
    build:
      context: ./
      dockerfile: ./dockerfiles/mailcatcher.Dockerfile
    description: TODO
    language: ruby
    interfaces:
      main: 1080
      smtp: 1025

  log:
    build:
      context: ./
      dockerfile: ./dockerfiles/log.Dockerfile
    interfaces:
    debug:
      volumes:
        app:
          host_path: ./
          mount_path: /app
        postfix_logs:
          host_path: ./postfix_log
          mount_path: /var/log
    # links db ?

# TODO: debug blocks, volumes, env vars in place of links
